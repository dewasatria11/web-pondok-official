<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Admin - PP Al Ikhsan Beji</title>
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="manifest" href="/manifest.webmanifest" />

  <!-- Prevent Caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Google: Inter (UI), Amiri (Arabic), & Rubik (Heading) -->
  <link
    href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@200;300;400;500;600&family=Rubik:wght@400;900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&display=swap" rel="stylesheet">
  <!-- FontAwesome untuk Ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pesantren: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            rubik: ['Rubik', 'sans-serif'],
            serif: ['"Traditional Arabic"', '"Aref Ruqaa"', 'Amiri', 'serif'],
          }
        }
      }
    }
  </script>
  <style>
    .islamic-pattern {
      background-image: radial-gradient(#ffffff 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.1;
    }

    /* Animated Green Pattern for Login Card Area */
    .login-pattern-bg {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .login-pattern-bg::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(5, 150, 105, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(4, 120, 87, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 70% 20%, rgba(6, 95, 70, 0.04) 0%, transparent 45%);
      animation: patternFloat 20s ease-in-out infinite;
    }

    .login-pattern-bg::after {
      content: '';
      position: absolute;
      width: 150%;
      height: 150%;
      top: -25%;
      left: -25%;
      background-image:
        repeating-linear-gradient(45deg,
          transparent,
          transparent 30px,
          rgba(16, 185, 129, 0.015) 30px,
          rgba(16, 185, 129, 0.015) 60px),
        repeating-linear-gradient(-45deg,
          transparent,
          transparent 30px,
          rgba(5, 150, 105, 0.01) 30px,
          rgba(5, 150, 105, 0.01) 60px);
      animation: patternDrift 30s linear infinite;
    }

    /* Floating circles animation */
    .floating-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.4;
      animation: orbFloat 15s ease-in-out infinite;
    }

    .floating-orb-1 {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%);
      top: -50px;
      right: -50px;
      animation-delay: 0s;
    }

    .floating-orb-2 {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, rgba(4, 120, 87, 0.12) 0%, rgba(6, 78, 59, 0.08) 100%);
      bottom: -30px;
      left: -30px;
      animation-delay: -5s;
      animation-duration: 18s;
    }

    .floating-orb-3 {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
      top: 40%;
      right: 10%;
      animation-delay: -10s;
      animation-duration: 12s;
    }

    @keyframes patternFloat {

      0%,
      100% {
        transform: translate(0, 0) rotate(0deg);
      }

      25% {
        transform: translate(-2%, 1%) rotate(1deg);
      }

      50% {
        transform: translate(1%, -1%) rotate(-0.5deg);
      }

      75% {
        transform: translate(-1%, -2%) rotate(0.5deg);
      }
    }

    @keyframes patternDrift {
      0% {
        transform: translate(0, 0);
      }

      100% {
        transform: translate(30px, 30px);
      }
    }

    @keyframes orbFloat {

      0%,
      100% {
        transform: translate(0, 0) scale(1);
      }

      25% {
        transform: translate(10px, -15px) scale(1.05);
      }

      50% {
        transform: translate(-5px, 10px) scale(0.95);
      }

      75% {
        transform: translate(-10px, -5px) scale(1.02);
      }
    }

    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {

      .login-pattern-bg::before,
      .login-pattern-bg::after,
      .floating-orb {
        animation: none;
      }
    }

    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }

    #loadingOverlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Main container hidden initially */
    .main-container {
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .main-container.visible {
      opacity: 1;
    }

    /* Error alert */
    .alert-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .alert-error.show {
      display: flex;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans antialiased">

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="text-center">
      <i class="fas fa-circle-notch fa-spin text-white text-4xl mb-4"></i>
      <p class="text-white text-lg font-light">Memeriksa sesi...</p>
    </div>
  </div>

  <!-- Container Utama -->
  <div class="main-container w-full min-h-screen flex overflow-hidden shadow-2xl">

    <!-- BAGIAN KIRI: Narasi & Gambar -->
    <div
      class="hidden md:flex md:w-1/2 lg:w-3/5 bg-pesantren-900 relative flex-col justify-between text-white overflow-hidden">

      <!-- Background Image -->
      <img src="https://images.unsplash.com/photo-1609599006353-e629aaabfeae?q=80&w=2070&auto=format&fit=crop"
        alt="Al-Quran Al-Karim" class="absolute inset-0 w-full h-full object-cover opacity-60 mix-blend-overlay"
        onerror="this.src='https://images.unsplash.com/photo-1585036156171-384164a8c675?q=80&w=2070';">

      <!-- Overlay Gradient -->
      <div class="absolute inset-0 bg-gradient-to-br from-pesantren-900/95 via-pesantren-800/80 to-transparent"></div>

      <!-- Islamic Pattern -->
      <div class="absolute inset-0 islamic-pattern"></div>

      <!-- Konten Narasi -->
      <div class="relative z-10 p-12 h-full flex flex-col justify-center">
        <div class="mb-8">
          <div class="text-white mb-6">
            <h2
              class="text-4xl lg:text-6xl font-serif font-medium leading-normal mb-4 text-center lg:text-left drop-shadow-sm">
              ٱلسَّلَامُ عَلَيْكُمْ وَرَحْمَةُ ٱللَّٰهِ وَبَرَكَاتُهُ
            </h2>
            <div class="inline-block border-b border-pesantren-400/30 pb-4 mt-2">
              <span class="text-pesantren-50 text-2xl font-light tracking-wide italic font-sans">Portal Pendidik &
                Pengelola</span>
            </div>
          </div>
          <p class="text-lg text-pesantren-50 max-w-md leading-relaxed font-thin tracking-wide">
            "Selamat datang para pendidik, guru, ustadz, dan juga pengelola web. Mari bersinergi dalam kebaikan."
          </p>
        </div>

        <div class="mt-8 pl-4 border-l-2 border-pesantren-300/40">
          <h3 class="font-sans font-normal uppercase tracking-[0.2em] text-xs text-pesantren-200 mb-1">Sistem Informasi
            Manajemen</h3>
          <p class="text-2xl font-serif text-white tracking-wide">Pondok Pesantren Al Ikhsan Beji</p>
        </div>
      </div>

      <!-- Copyright footer kiri -->
      <div class="relative z-10 p-12 pt-0 text-xs opacity-50 font-light tracking-wider">
        &copy; 2026 TIM IT PESANTREN AL IKHSAN BEJI
      </div>
    </div>

    <!-- BAGIAN KANAN: Form Login -->
    <div
      class="w-full md:w-1/2 lg:w-2/5 flex flex-col items-center justify-center p-6 bg-gray-50 relative overflow-hidden">

      <!-- Animated Green Pattern Background -->
      <div class="login-pattern-bg">
        <div class="floating-orb floating-orb-1"></div>
        <div class="floating-orb floating-orb-2"></div>
        <div class="floating-orb floating-orb-3"></div>
      </div>

      <!-- Card Login -->
      <div
        class="w-full max-w-sm z-10 bg-white/95 backdrop-blur-sm rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] p-8 sm:p-10 border border-gray-100">

        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-black text-pesantren-900 font-rubik tracking-tight uppercase">Login</h1>
          <div class="w-8 h-1 bg-pesantren-200 mx-auto mt-3 rounded-full"></div>
        </div>

        <!-- Error Alert -->
        <div class="alert-error mb-4" id="alertError">
          <i class="fas fa-exclamation-circle"></i>
          <span id="errorMessage">Email atau password salah</span>
        </div>

        <!-- Form -->
        <form id="loginForm" class="space-y-6">

          <!-- Input Email -->
          <div>
            <label for="email"
              class="block text-[10px] font-bold text-gray-400 uppercase tracking-[0.15em] mb-2 ml-1">Email</label>
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-colors group-focus-within:text-pesantren-600">
                <i class="far fa-envelope text-gray-400 group-focus-within:text-pesantren-600"></i>
              </div>
              <input type="email" id="email" name="email" required
                class="pl-11 w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:bg-white focus:ring-2 focus:ring-pesantren-100 focus:border-pesantren-500 transition-all duration-300 text-sm text-gray-700 placeholder-gray-400 font-light"
                placeholder="Masukkan email" autocomplete="username">
            </div>
          </div>

          <!-- Input Password -->
          <div>
            <label for="password"
              class="block text-[10px] font-bold text-gray-400 uppercase tracking-[0.15em] mb-2 ml-1">Kata Sandi</label>
            <div class="relative group">
              <div
                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none transition-colors group-focus-within:text-pesantren-600">
                <i class="fas fa-lock text-gray-400 group-focus-within:text-pesantren-600"></i>
              </div>
              <input type="password" id="password" name="password" required
                class="pl-11 pr-11 w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:bg-white focus:ring-2 focus:ring-pesantren-100 focus:border-pesantren-500 transition-all duration-300 text-sm text-gray-700 placeholder-gray-400 font-light"
                placeholder="••••••••" autocomplete="current-password">
              <button type="button" onclick="togglePassword()"
                class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-pesantren-600 transition-colors cursor-pointer">
                <i id="eye-icon" class="far fa-eye"></i>
              </button>
            </div>
          </div>

          <!-- Button Login -->
          <button type="submit" id="btnLogin"
            class="w-full bg-pesantren-600 text-white py-3.5 rounded-xl font-medium tracking-wide hover:bg-pesantren-700 focus:outline-none focus:ring-4 focus:ring-pesantren-100 transform transition-all duration-300 shadow-lg hover:shadow-pesantren-200 hover:-translate-y-0.5 mt-2 disabled:opacity-75 disabled:cursor-not-allowed disabled:transform-none">
            Masuk
          </button>
        </form>

        <!-- Back to Home -->
        <div class="mt-6 text-center">
          <a href="/" class="text-sm text-gray-400 hover:text-pesantren-600 transition-colors font-light">
            <i class="fas fa-arrow-left mr-1"></i> Kembali ke Website
          </a>
        </div>

        <!-- Footer -->
        <p class="mt-6 text-center text-xs font-light text-gray-400 tracking-wide">
          &copy; 2026 Al Ikhsan Beji
        </p>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="/assets/js/pwa.js" defer></script>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://sxbvadzcwpaovkhghttv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4YnZhZHpjd3Bhb3ZraGdodHR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMDg4MDYsImV4cCI6MjA3NjY4NDgwNn0.miJeKmsNgjgS4fWegGlwrxF_cPUoZBT0YKl1oxmmXTE';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        // Gunakan sessionStorage agar sesi bertahan saat navigasi,
        // tapi hilang saat browser/tab ditutup
        storage: window.sessionStorage,
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true
      }
    });

    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const alertError = document.getElementById('alertError');
    const errorMessage = document.getElementById('errorMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainContainer = document.querySelector('.main-container');

    // Toggle Password Visibility
    function togglePassword() {
      const eyeIcon = document.getElementById('eye-icon');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
      }
    }

    // Check if already logged in
    async function checkSession() {
      try {
        // Check if we just got redirected from admin (prevent loop)
        const wasRedirectedFromAdmin = sessionStorage.getItem('admin_auth_redirecting') === 'true';
        if (wasRedirectedFromAdmin) {
          console.log('[LOGIN] Was redirected from admin, showing login form');
          sessionStorage.removeItem('admin_auth_redirecting');
          showLoginForm();
          return;
        }

        console.log('[LOGIN] Checking existing session...');

        // Small delay to ensure sessionStorage is ready
        await new Promise(resolve => setTimeout(resolve, 50));

        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error) {
          console.warn('[LOGIN] Session check error:', error.message);
          showLoginForm();
          return;
        }

        if (session && session.user) {
          console.log('[LOGIN] ✅ Already logged in:', session.user.email);
          window.location.replace('/admin.html');
          return;
        }

        console.log('[LOGIN] No active session found');
        showLoginForm();

      } catch (error) {
        console.error('[LOGIN] Error checking session:', error);
        showLoginForm();
      }
    }

    // Helper to show login form
    function showLoginForm() {
      mainContainer.classList.add('visible');
      loadingOverlay.classList.add('hidden');
    }

    // Handle login form submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showError('Masukkan email dan password');
        return;
      }

      // Show loading state
      btnLogin.disabled = true;
      btnLogin.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Memproses...';
      hideError();

      try {
        console.log('[LOGIN] Attempting Supabase Auth login for:', email);

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          console.error('[LOGIN] Auth error:', error);
          throw error;
        }

        console.log('[LOGIN] ✅ Login successful!', data.user.email);

        // NOTE: Sesi disimpan di sessionStorage, bertahan saat navigasi
        // Tapi akan hilang saat browser/tab ditutup

        // Show success state
        btnLogin.innerHTML = '<i class="fas fa-check mr-2"></i>Berhasil';
        btnLogin.classList.remove('bg-pesantren-600', 'hover:bg-pesantren-700');
        btnLogin.classList.add('bg-emerald-500');

        // Redirect to admin (use replace to prevent back button issues)
        setTimeout(() => {
          window.location.replace('/admin.html');
        }, 500);

      } catch (error) {
        console.error('[LOGIN] Login failed:', error);

        let msg = 'Email atau password salah';
        if (error.message) {
          if (error.message.includes('Invalid login')) {
            msg = 'Email atau password salah';
          } else if (error.message.includes('Email not confirmed')) {
            msg = 'Email belum dikonfirmasi';
          } else if (error.message.includes('Too many requests')) {
            msg = 'Terlalu banyak percobaan. Coba lagi nanti.';
          } else if (error.message.includes('User not found')) {
            msg = 'Akun tidak ditemukan';
          }
        }

        showError(msg);

        // Reset button
        btnLogin.disabled = false;
        btnLogin.innerHTML = 'Masuk';
      }
    });

    function showError(msg) {
      errorMessage.textContent = msg;
      alertError.classList.add('show');
    }

    function hideError() {
      alertError.classList.remove('show');
    }

    // Check session on page load
    checkSession();
  </script>
</body>

</html>